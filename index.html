<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Cap</title>
    
<style>
:root {
    --bg: #fafafa;
    --surface: #ffffff;
    --text: #1d1d1f;
    --text-secondary: #6e6e73;
    --text-tertiary: #86868b;
    --border: #d2d2d7;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.47059;
    font-size: 15px;
    padding: 48px 24px;
    -webkit-font-smoothing: antialiased;
    font-weight: 400;
    letter-spacing: -0.016em;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
}

header {
    padding: 0 0 24px 0;
    margin-bottom: 32px;
}

h1 {
    font-size: 48px;
    font-weight: 590;
    margin-bottom: 8px;
    letter-spacing: -0.032em;
    color: var(--text);
}

.subtitle {
    font-size: 19px;
    color: var(--text-secondary);
    font-weight: 400;
    letter-spacing: -0.022em;
}

.last-updated {
    font-size: 13px;
    color: var(--text-tertiary);
    margin-top: 16px;
    font-weight: 400;
}

.controls {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
}

.btn {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 980px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    font-weight: 400;
    letter-spacing: -0.016em;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}

.btn:hover {
    background: #f5f5f7;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.btn:active {
    transform: scale(0.98);
}

#treemap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    overflow: hidden;
    position: relative;
    height: 680px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.06);
}

.treemap-cell {
    position: absolute;
    border: 1.5px solid var(--bg);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.treemap-cell:hover {
    opacity: 0.9;
    z-index: 10;
    border-width: 2px;
}

.cell-ticker {
    font-size: 20px;
    font-weight: 590;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    margin-bottom: 4px;
    letter-spacing: -0.022em;
}

.cell-marketcap {
    font-size: 16px;
    font-weight: 500;
    color: rgba(255,255,255,0.95);
    text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    margin-bottom: 8px;
    letter-spacing: -0.016em;
}

.cell-change {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255,255,255,0.92);
    text-shadow: 0 1px 2px rgba(0,0,0,0.15);
    margin-bottom: 4px;
}

.cell-price {
    font-size: 12px;
    font-weight: 400;
    color: rgba(255,255,255,0.88);
    text-shadow: 0 1px 2px rgba(0,0,0,0.12);
}

.loading {
    text-align: center;
    padding: 48px;
    color: var(--text-tertiary);
    font-size: 15px;
}

.error {
    background: rgba(255, 59, 48, 0.06);
    border: 1px solid rgba(255, 59, 48, 0.15);
    color: #d60000;
    padding: 16px;
    border-radius: 12px;
    margin: 20px;
    text-align: center;
    font-size: 15px;
}

.treemap-cell.small .cell-ticker { font-size: 16px; }
.treemap-cell.small .cell-marketcap { font-size: 13px; }
.treemap-cell.small .cell-change { font-size: 12px; }
.treemap-cell.small .cell-price { font-size: 10px; }

.treemap-cell.tiny .cell-ticker { font-size: 13px; }
.treemap-cell.tiny .cell-marketcap { font-size: 11px; }
.treemap-cell.tiny .cell-change { font-size: 10px; }
.treemap-cell.tiny .cell-price { display: none; }

.treemap-cell.micro .cell-ticker { font-size: 11px; font-weight: 500; }
.treemap-cell.micro .cell-marketcap { font-size: 9px; }
.treemap-cell.micro .cell-change { display: none; }
.treemap-cell.micro .cell-price { display: none; }
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Market Cap</h1>
            <div class="subtitle">Size by market capitalization · Color by performance</div>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <div class="controls">
            <button class="btn" onclick="refreshData()">Refresh</button>
        </div>

        <div id="treemap">
            <div class="loading">Loading...</div>
        </div>
    </div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1svXheHx4C1XVLITnVsW7nbT0v-B8tJxDviZG-Op2v58/gviz/tq?tqx=out:csv&gid=414313148';

let stockData = [];

async function fetchStockData() {
    try {
        console.log('Fetching data from sheet...');
        const response = await fetch(SHEET_URL + '&t=' + Date.now());
        if (!response.ok) throw new Error('Failed to fetch');
        
        const csv = await response.text();
        console.log('CSV received, first 200 chars:', csv.substring(0, 200));
        
        const lines = csv.split('\n');
        console.log('Total lines:', lines.length);
        
        // Parse CSV properly handling quotes
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        const headers = parseCSVLine(lines[0]);
        console.log('Headers:', headers);
        
        const tickerIndex = headers.indexOf('Ticker');
        const priceIndex = headers.indexOf('Price');
        const changeIndex = headers.indexOf('Change%');
        const marketCapIndex = headers.indexOf('Marketcap');
        
        console.log('Column indices:', { tickerIndex, priceIndex, changeIndex, marketCapIndex });
        
        if (tickerIndex === -1 || priceIndex === -1 || changeIndex === -1 || marketCapIndex === -1) {
            throw new Error('Missing required columns');
        }
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = parseCSVLine(lines[i]);
            if (values.length > tickerIndex && values[tickerIndex]) {
                const ticker = values[tickerIndex];
                const percentChange = parseFloat(values[changeIndex].replace(/[^0-9.-]/g, ''));
                const marketCapRaw = values[marketCapIndex].replace(/[\$,]/g, '');
                const marketCapBillions = parseFloat(marketCapRaw) / 1000000000;
                
                console.log(`${ticker}: raw="${values[marketCapIndex]}", cleaned="${marketCapRaw}", billions=${marketCapBillions}`);
                
                if (marketCapBillions > 0 && !isNaN(marketCapBillions)) {
                    data.push({
                        ticker: ticker,
                        price: parseFloat(values[priceIndex].replace(/[^0-9.]/g, '')),
                        percentChange: percentChange,
                        marketCap: marketCapBillions
                    });
                }
            }
        }
        
        console.log('Parsed data:', data.length, 'stocks');
        console.log('Sample:', data.slice(0, 3));
        return data;
    } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
    }
}

function getColor(percentChange) {
    // Subtle, refined Apple-like colors
    if (percentChange >= 5) return "#34c759";
    if (percentChange >= 3) return "#52d97d";
    if (percentChange >= 2) return "#7ee09f";
    if (percentChange >= 1) return "#a8e6c3";
    if (percentChange > 0) return "#d0f0e0";
    if (percentChange === 0) return "#98989d";
    if (percentChange > -1) return "#ffd3d3";
    if (percentChange > -2) return "#ffb3b3";
    if (percentChange > -3) return "#ff8a8a";
    if (percentChange > -5) return "#ff6666";
    return "#ff3b30";
}

function squarify(data, x, y, width, height) {
    if (data.length === 0) return [];
    if (data.length === 1) {
        return [{
            ...data[0],
            x: x,
            y: y,
            width: width,
            height: height
        }];
    }
    
    const total = data.reduce((sum, d) => sum + d.value, 0);
    
    // Sort by size descending
    const sorted = [...data].sort((a, b) => b.value - a.value);
    
    const result = [];
    let remaining = [...sorted];
    let currentX = x;
    let currentY = y;
    let remainingWidth = width;
    let remainingHeight = height;
    
    while (remaining.length > 0) {
        const isHorizontal = remainingWidth >= remainingHeight;
        
        // Calculate remaining total
        const remainingTotal = remaining.reduce((sum, d) => sum + d.value, 0);
        
        // Take items for this row/column
        let rowItems = [];
        let rowSum = 0;
        
        for (let i = 0; i < remaining.length; i++) {
            const item = remaining[i];
            const testSum = rowSum + item.value;
            const proportion = testSum / remainingTotal;
            
            rowItems.push(item);
            rowSum += item.value;
            
            // Stop if we've used a good proportion or this is the last item
            if (proportion > 0.35 || i === remaining.length - 1) {
                break;
            }
        }
        
        // Layout this row
        if (isHorizontal) {
            const rowWidth = (rowSum / remainingTotal) * remainingWidth;
            let offsetY = currentY;
            
            rowItems.forEach(item => {
                const itemHeight = (item.value / rowSum) * remainingHeight;
                result.push({
                    ...item,
                    x: currentX,
                    y: offsetY,
                    width: rowWidth,
                    height: itemHeight
                });
                offsetY += itemHeight;
            });
            
            currentX += rowWidth;
            remainingWidth -= rowWidth;
        } else {
            const rowHeight = (rowSum / remainingTotal) * remainingHeight;
            let offsetX = currentX;
            
            rowItems.forEach(item => {
                const itemWidth = (item.value / rowSum) * remainingWidth;
                result.push({
                    ...item,
                    x: offsetX,
                    y: currentY,
                    width: itemWidth,
                    height: rowHeight
                });
                offsetX += itemWidth;
            });
            
            currentY += rowHeight;
            remainingHeight -= rowHeight;
        }
        
        remaining = remaining.slice(rowItems.length);
    }
    
    return result;
}

function createTreemap(data, width, height) {
    const sorted = [...data].sort((a, b) => b.marketCap - a.marketCap);
    const withValue = sorted.map(d => ({ ...d, value: d.marketCap }));
    return squarify(withValue, 0, 0, width, height);
}

function render() {
    const container = document.getElementById('treemap');
    console.log('Rendering treemap...');
    console.log('Stock data length:', stockData.length);
    
    if (stockData.length === 0) {
        container.innerHTML = '<div class="loading">No data available</div>';
        return;
    }
    
    const rect = container.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    
    console.log('Container dimensions:', width, 'x', height);
    
    const layout = createTreemap(stockData, width, height);
    console.log('Layout created:', layout.length, 'cells');
    console.log('Sample layout item:', layout[0]);
    
    container.innerHTML = layout.map(item => {
        const color = getColor(item.percentChange);
        const arrow = item.percentChange >= 0 ? '▲' : '▼';
        const sign = item.percentChange >= 0 ? '+' : '';
        
        const area = item.width * item.height;
        let sizeClass = '';
        if (area < 5000) sizeClass = 'micro';
        else if (area < 12000) sizeClass = 'tiny';
        else if (area < 25000) sizeClass = 'small';
        
        // Debug log for first item
        if (item.ticker === 'NVDA') {
            console.log('NVDA item:', item);
            console.log('NVDA marketCap:', item.marketCap);
        }
        
        let marketCapDisplay;
        if (item.marketCap >= 1000) {
            marketCapDisplay = '$' + (item.marketCap / 1000).toFixed(2) + 'T';
        } else if (item.marketCap >= 1) {
            marketCapDisplay = '$' + Math.round(item.marketCap) + 'B';
        } else {
            marketCapDisplay = '$' + Math.round(item.marketCap * 1000) + 'M';
        }
        
        return `
            <div class="treemap-cell ${sizeClass}" style="
                left: ${item.x}px;
                top: ${item.y}px;
                width: ${item.width}px;
                height: ${item.height}px;
                background-color: ${color};
            ">
                <div class="cell-ticker">${item.ticker}</div>
                <div class="cell-marketcap">${marketCapDisplay}</div>
                <div class="cell-change">${arrow} ${sign}${item.percentChange.toFixed(2)}%</div>
                <div class="cell-price">$${item.price.toFixed(2)}</div>
            </div>
        `;
    }).join('');
    
    console.log('Render complete');
    
    document.getElementById('lastUpdated').textContent = 
        `Last updated: ${new Date().toLocaleTimeString()}`;
}

async function refreshData() {
    const container = document.getElementById('treemap');
    container.innerHTML = '<div class="loading">Refreshing...</div>';
    
    try {
        stockData = await fetchStockData();
        render();
    } catch (error) {
        container.innerHTML = '<div class="error">Failed to load data. Please try again.</div>';
    }
}

let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(render, 250);
});

refreshData();
setInterval(refreshData, 5 * 60 * 1000);
</script>
</body>
</html>

Now update the color function for more subtle, Apple-like colors:
