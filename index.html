<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defense Stock Treemap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
    
<style>
:root {
    --bg-primary: #1a1a1a;
    --bg-secondary: #252525;
    --surface: #222222;
    --border-light: #3a3a3a;
    --text-primary: #e0e0e0;
    --text-secondary: #b0b0b0;
    --text-tertiary: #808080;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Atkinson Hyperlegible Next', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.4;
    padding: 20px;
    -webkit-font-smoothing: antialiased;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
}

header {
    padding: 20px 0 30px 0;
    border-bottom: 1px solid var(--border-light);
    margin-bottom: 30px;
}

h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 10px;
}

.subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.last-updated {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 10px;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.btn {
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    color: var(--text-primary);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    transition: all 0.2s;
}

.btn:hover {
    background: var(--surface);
}

#treemap {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    height: 700px;
}

.treemap-cell {
    position: absolute;
    border: 2px solid var(--bg-primary);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
}

.treemap-cell:hover {
    opacity: 0.9;
    z-index: 10;
    transform: scale(1.02);
}

.cell-ticker {
    font-size: 24px;
    font-weight: 700;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    margin-bottom: 4px;
}

.cell-change {
    font-size: 18px;
    font-weight: 600;
    color: white;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    margin-bottom: 8px;
}

.cell-price {
    font-size: 14px;
    color: rgba(255,255,255,0.9);
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}

.cell-marketcap {
    font-size: 12px;
    color: rgba(255,255,255,0.8);
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    margin-top: 4px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: var(--text-tertiary);
    font-size: 14px;
}

.error {
    background: rgba(248, 113, 113, 0.1);
    border: 1px solid rgba(248, 113, 113, 0.3);
    color: #f87171;
    padding: 16px 20px;
    border-radius: 8px;
    margin: 20px;
    text-align: center;
}

/* Small cells get smaller text */
.treemap-cell.small .cell-ticker {
    font-size: 16px;
}

.treemap-cell.small .cell-change {
    font-size: 14px;
}

.treemap-cell.small .cell-price,
.treemap-cell.small .cell-marketcap {
    font-size: 10px;
}

.treemap-cell.tiny .cell-ticker {
    font-size: 14px;
}

.treemap-cell.tiny .cell-change {
    font-size: 12px;
}

.treemap-cell.tiny .cell-price,
.treemap-cell.tiny .cell-marketcap {
    display: none;
}
</style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ¯ Defense Stock Market Cap Treemap</h1>
            <div class="subtitle">Size = Market Cap | Color = Performance</div>
            <div class="last-updated" id="lastUpdated">Loading...</div>
        </header>

        <div class="controls">
            <button class="btn" onclick="refreshData()">Refresh</button>
        </div>

        <div id="treemap">
            <div class="loading">Loading stock data...</div>
        </div>
    </div>

<script>
// Your existing Google Sheet URL
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1svXheHx4C1XVLITnVsW7nbT0v-B8tJxDviZG-Op2v58/gviz/tq?tqx=out:csv&sheet=Sheet1';

let stockData = [];

// Fetch stock data from Google Sheet
async function fetchStockData() {
    try {
        const response = await fetch(SHEET_URL + '&t=' + Date.now());
        if (!response.ok) throw new Error('Failed to fetch');
        
        const csv = await response.text();
        const lines = csv.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        
        const tickerIndex = headers.indexOf('Ticker');
        const priceIndex = headers.indexOf('Price');
        const changeIndex = headers.indexOf('Change%');
        const marketCapIndex = headers.indexOf('Marketcap');
        
        if (tickerIndex === -1 || priceIndex === -1 || changeIndex === -1 || marketCapIndex === -1) {
            throw new Error('Missing required columns');
        }
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            if (values.length > tickerIndex && values[tickerIndex]) {
                const ticker = values[tickerIndex];
                const percentChange = parseFloat(values[changeIndex].replace(/[^0-9.-]/g, ''));
                const marketCapRaw = values[marketCapIndex].replace(/[^0-9]/g, '');
                const marketCapBillions = parseFloat(marketCapRaw) / 1000000000;
                
                if (marketCapBillions > 0) {
                    data.push({
                        ticker: ticker,
                        price: parseFloat(values[priceIndex].replace(/[^0-9.]/g, '')),
                        percentChange: percentChange,
                        marketCap: marketCapBillions
                    });
                }
            }
        }
        
        return data;
    } catch (error) {
        console.error('Error fetching data:', error);
        throw error;
    }
}

// Get color based on percent change
function getColor(percentChange) {
    // Strong positive: bright green
    if (percentChange >= 5) return '#22c55e';
    if (percentChange >= 3) return '#4ade80';
    if (percentChange >= 1) return '#86efac';
    if (percentChange > 0) return '#bbf7d0';
    
    // Neutral
    if (percentChange === 0) return '#6b7280';
    
    // Negative: shades of red
    if (percentChange > -1) return '#fca5a5';
    if (percentChange > -3) return '#f87171';
    if (percentChange > -5) return '#ef4444';
    return '#dc2626';
}

// Simple treemap layout using squarified algorithm
function createTreemap(data, width, height) {
    const total = data.reduce((sum, d) => sum + d.marketCap, 0);
    const items = data.map(d => ({
        ...d,
        normalizedValue: d.marketCap / total
    })).sort((a, b) => b.marketCap - a.marketCap);
    
    const layout = [];
    let x = 0, y = 0, rowHeight = 0;
    let currentRow = [];
    let remainingWidth = width;
    
    items.forEach((item, index) => {
        const area = item.normalizedValue * width * height;
        const itemWidth = area / (height - y);
        
        if (x + itemWidth > width && currentRow.length > 0) {
            // Start new row
            y += rowHeight;
            x = 0;
            rowHeight = 0;
            currentRow = [];
            remainingWidth = width;
        }
        
        const h = rowHeight || (area / itemWidth);
        
        layout.push({
            ...item,
            x: x,
            y: y,
            width: itemWidth,
            height: h
        });
        
        x += itemWidth;
        rowHeight = Math.max(rowHeight, h);
        currentRow.push(item);
        remainingWidth -= itemWidth;
    });
    
    return layout;
}

// Render treemap
function render() {
    const container = document.getElementById('treemap');
    
    if (stockData.length === 0) {
        container.innerHTML = '<div class="loading">No data available</div>';
        return;
    }
    
    const rect = container.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;
    
    const layout = createTreemap(stockData, width, height);
    
    container.innerHTML = layout.map(item => {
        const color = getColor(item.percentChange);
        const arrow = item.percentChange >= 0 ? 'â–²' : 'â–¼';
        const sign = item.percentChange >= 0 ? '+' : '';
        
        // Determine size class for font scaling
        const area = item.width * item.height;
        let sizeClass = '';
        if (area < 8000) sizeClass = 'tiny';
        else if (area < 15000) sizeClass = 'small';
        
        return `
            <div class="treemap-cell ${sizeClass}" style="
                left: ${item.x}px;
                top: ${item.y}px;
                width: ${item.width}px;
                height: ${item.height}px;
                background-color: ${color};
            ">
                <div class="cell-ticker">${item.ticker}</div>
                <div class="cell-change">${arrow} ${sign}${item.percentChange.toFixed(2)}%</div>
                <div class="cell-price">$${item.price.toFixed(2)}</div>
                <div class="cell-marketcap">${item.marketCap >= 1 ? '$' + item.marketCap.toFixed(1) + 'B' : '$' + (item.marketCap * 1000).toFixed(0) + 'M'}</div>
            </div>
        `;
    }).join('');
    
    document.getElementById('lastUpdated').textContent = 
        `Last updated: ${new Date().toLocaleTimeString()}`;
}

// Refresh data
async function refreshData() {
    const container = document.getElementById('treemap');
    container.innerHTML = '<div class="loading">Refreshing...</div>';
    
    try {
        stockData = await fetchStockData();
        render();
    } catch (error) {
        container.innerHTML = '<div class="error">Failed to load data. Please try again.</div>';
    }
}

// Handle window resize
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(render, 250);
});

// Initial load
refreshData();

// Auto-refresh every 5 minutes
setInterval(refreshData, 5 * 60 * 1000);
</script>
</body>
</html>
