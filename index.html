<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Side Projects</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Helvetica Neue',Arial,sans-serif;background:#f5f5f5;color:#333;line-height:1.7}
    .header{background:#fff;border-bottom:1px solid #e0e0e0;padding:20px;position:sticky;top:0;z-index:100}
    .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.5em;font-weight:600;letter-spacing:-0.02em}
    .nav{display:flex;gap:24px}
    .nav-item{color:#666;text-decoration:none;font-size:.95em;transition:color .2s}
    .nav-item:hover{color:#000}
    .container{max-width:1200px;margin:40px auto;padding:0 20px}
    .filter-section{margin-bottom:40px}
    .filter-pills{display:flex;gap:12px;flex-wrap:wrap}
    .filter-pill{padding:8px 20px;background:#fff;border:1px solid #e0e0e0;color:#666;cursor:pointer;font-size:.9em;border-radius:20px;transition:all .2s}
    .filter-pill:hover{border-color:#333;color:#000}
    .filter-pill.active{background:#000;color:#fff;border-color:#000}
    .feed{column-count:3;column-gap:24px}
    @media(max-width:1024px){.feed{column-count:2}}
    @media(max-width:768px){.feed{column-count:1}}
    .card{background:#fff;padding:32px;border:1px solid #e0e0e0;transition:all .3s ease;break-inside:avoid;margin-bottom:24px}
    .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);transform:translateY(-2px)}
    .card-date{font-size:.8em;color:#999;text-transform:uppercase;letter-spacing:.05em;margin-bottom:16px}
    .card-title{font-size:1.3em;font-weight:600;line-height:1.4;margin-bottom:16px}
    .card-title a{color:#000;text-decoration:none;transition:opacity .2s}
    .card-title a:hover{opacity:.6}
    .card-highlight{padding:2px 6px;margin:0 -2px;border-radius:4px}
    .highlight-yellow{background:#ffeb3b}
    .highlight-pink{background:#ffcdd2}
    .highlight-blue{background:#bbdefb}
    .highlight-green{background:#c8e6c9}
    .card-excerpt{font-size:.95em;color:#666;margin-bottom:20px}
    .card-meta{display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:1px solid #f0f0f0}
    .card-source{font-size:.85em;color:#999}
    .card-link{font-size:.85em;color:#000;text-decoration:none;font-weight:500}
    .card-link:hover{opacity:.6}
    .loading{text-align:center;padding:60px 20px;color:#999}
    .loading-dots span{display:inline-block;width:8px;height:8px;background:#ddd;border-radius:50%;margin:0 4px;animation:bounce 1.4s infinite ease-in-out both}
    .loading-dots span:nth-child(1){animation-delay:-.32s}
    .loading-dots span:nth-child(2){animation-delay:-.16s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="logo">Side Projects</div>
      <div class="nav">
        <a href="#" class="nav-item">All</a>
        <a href="#" class="nav-item">Indie</a>
        <a href="#" class="nav-item">Dev</a>
        <a href="#" class="nav-item">Business</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="filter-section">
      <div class="filter-pills" id="filterPills"></div>
    </div>
    <div id="loading" class="loading">
      <div class="loading-dots"><span></span><span></span><span></span></div>
      <div style="margin-top:16px;">Loading posts...</div>
    </div>
    <div class="feed" id="feed"></div>
  </div>

  <script>
    const PROXY = 'https://wild-morning-f940.markflournoy.workers.dev/?url=';

    const SOURCES = [
      { id:'all', name:'All', cat:'all' },
      { id:'SideProject', name:'SideProject', cat:'indie' },
      { id:'indiehackers', name:'IndieHackers', cat:'indie' },
      { id:'SaaS', name:'SaaS', cat:'business' },
      { id:'microSaaS', name:'MicroSaaS', cat:'business' },
      { id:'entrepreneur', name:'Entrepreneur', cat:'business' },
      { id:'sidehustle', name:'SideHustle', cat:'indie' },
      { id:'webdev', name:'WebDev', cat:'dev' }
    ];

    const highlights=['yellow','pink','blue','green'];
    let posts=[]; let filter='all';
    const CACHE_TTL=10*60*1000; //10min
    const MAX_POSTS=10; // per subreddit

    init();

    function init(){
      renderFilter();
      const cached=getCachedPosts();
      if(cached){posts=cached;render();}
      fetchPosts();
      setInterval(fetchPosts,300000); // 5min refresh
    }

    function getCachedPosts(){
      try{
        const cache=JSON.parse(localStorage.getItem('postsCache'));
        const ts=parseInt(localStorage.getItem('postsCacheTime'),10);
        if(cache && ts && (Date.now()-ts)<CACHE_TTL) return cache;
      }catch{}
      return null;
    }

    function cachePosts(data){
      localStorage.setItem('postsCache',JSON.stringify(data));
      localStorage.setItem('postsCacheTime',Date.now());
    }

    function renderFilter(){
      const container=document.getElementById('filterPills');
      SOURCES.forEach(src=>{
        const pill=document.createElement('button');
        pill.className='filter-pill'+(src.id==='all'?' active':'');
        pill.textContent=src.name;
        pill.onclick=()=>setFilter(src.id);
        container.appendChild(pill);
      });
    }

    function setFilter(id){
      filter=id;
      document.querySelectorAll('.filter-pill').forEach((pill,i)=>{
        pill.classList.toggle('active',SOURCES[i].id===id);
      });
      render();
    }

    async function fetchPosts(){
      try{
        const subs=SOURCES.slice(1);
        const results=[];
        for(const src of subs){
          const subPosts=await fetchSubreddit(src.id,src.cat);
          results.push(...subPosts);
          renderPartial(results.slice(0,15));
        }
        posts=results.sort((a,b)=>b.date-a.date).slice(0,50);
        cachePosts(posts);
        render();
      }catch(err){console.error('Fetch error:',err);}
    }

    async function fetchSubreddit(name,category){
      const url=`${PROXY}https://www.reddit.com/r/${name}/.rss`;
      const res=await fetch(url);
      if(!res.ok) return [];
      const text = await res.text();

// stop if Cloudflare returned an error
if (text.startsWith("Invalid RSS") || text.startsWith("Worker error")) {
  console.warn(`Skipping ${name}: bad RSS`);
  return [];
}

// try parsing as XML, handle malformed
let xml;
try {
  xml = new DOMParser().parseFromString(text, "application/xml");
  if (xml.querySelector("parsererror")) throw new Error("Invalid XML");
} catch {
  console.warn(`Bad XML from r/${name}`);
  return [];
}

      const items=xml.querySelectorAll('entry');
      return Array.from(items).slice(0,MAX_POSTS).map(item=>({
        title:item.querySelector('title')?.textContent||'',
        link:item.querySelector('link')?.getAttribute('href')||'#',
        author:item.querySelector('author name')?.textContent||'Unknown',
        date:new Date(item.querySelector('published')?.textContent),
        content:clean(item.querySelector('content')?.textContent||''),
        sub:name,category:category
      }));
    }

    function clean(html){
      const div=document.createElement('div');
      div.innerHTML=html;
      return (div.textContent||'')
        .replace(/https?:\/\/[^\s]+/g,'')
        .replace(/\s+/g,' ')
        .trim()
        .substring(0,180);
    }

    function highlightTitle(title){
      const words=title.split(' ');
      if(words.length>5){
        const i=Math.floor(Math.random()*(words.length-3))+1;
        const phrase=words.slice(i,i+3).join(' ');
        const color=highlights[Math.floor(Math.random()*highlights.length)];
        return title.replace(phrase,`<span class="card-highlight highlight-${color}">${phrase}</span>`);
      }
      return title;
    }

    function formatDate(date){
      const o={year:'numeric',month:'long',day:'numeric'};
      return date.toLocaleDateString('en-US',o).toUpperCase();
    }

    function renderPartial(temp){
      const feed=document.getElementById('feed');
      feed.innerHTML=temp.map(buildCard).join('');
    }

    function render(){
      document.getElementById('loading').style.display='none';
      const feed=document.getElementById('feed');
      const filtered=filter==='all'?posts:posts.filter(p=>p.sub===filter);
      feed.innerHTML=filtered.map(buildCard).join('');
    }

    function buildCard(post){
      return `
      <article class="card">
        <div class="card-date">${formatDate(post.date)}</div>
        <h2 class="card-title"><a href="${post.link}" target="_blank">${highlightTitle(escapeHTML(post.title))}</a></h2>
        ${post.content?`<p class="card-excerpt">${escapeHTML(post.content)}</p>`:''}
        <div class="card-meta">
          <span class="card-source">r/${post.sub}</span>
          <a href="${post.link}" target="_blank" class="card-link">Read â†’</a>
        </div>
      </article>`;
    }

    function escapeHTML(t){
      const d=document.createElement('div');
      d.textContent=t;
      return d.innerHTML;
    }
  </script>
</body>
</html>
